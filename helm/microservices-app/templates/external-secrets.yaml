{{- if .Values.vault.enabled }}
---
# SecretStore connects External Secrets Operator to Vault
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "microservices-app.labels" . | nindent 4 }}
spec:
  provider:
    vault:
      server: "http://vault.vault.svc.cluster.local:8200"
      path: "secret"
      version: "v2"
      auth:
        # Kubernetes authentication
        kubernetes:
          mountPath: "kubernetes"
          role: {{ printf "%s-vault-role" .Values.environment | quote }}
          serviceAccountRef:
            name: {{ include "microservices-app.serviceAccountName" . }}

---
# ExternalSecret for database credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-credentials
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "microservices-app.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.vault.refreshInterval | default "1h" }}
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: database-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        username: {{ `"{{ .username }}"` }}
        password: {{ `"{{ .password }}"` }}
        database: {{ `"{{ .database }}"` }}
  data:
    - secretKey: username
      remoteRef:
        key: {{ printf "%s/database" .Values.environment }}
        property: username
    - secretKey: password
      remoteRef:
        key: {{ printf "%s/database" .Values.environment }}
        property: password
    - secretKey: database
      remoteRef:
        key: {{ printf "%s/database" .Values.environment }}
        property: database

---
# ExternalSecret for backend API keys
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: backend-api-credentials
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "microservices-app.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.vault.refreshInterval | default "1h" }}
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: backend-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        api-key: {{ `"{{ .apiKey }}"` }}
        jwt-secret: {{ `"{{ .jwtSecret }}"` }}
  data:
    - secretKey: apiKey
      remoteRef:
        key: {{ printf "%s/backend" .Values.environment }}
        property: api_key
    - secretKey: jwtSecret
      remoteRef:
        key: {{ printf "%s/backend" .Values.environment }}
        property: jwt_secret

{{- end }}
