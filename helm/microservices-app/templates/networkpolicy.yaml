{{- if .Values.networkPolicy.enabled }}
---
# Default Deny All - Baseline Security
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "microservices-app.fullname" . }}-default-deny
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "microservices-app.labels" . | nindent 4 }}
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

---
# Allow DNS - Required for service discovery
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "microservices-app.fullname" . }}-allow-dns
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "microservices-app.labels" . | nindent 4 }}
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

{{- if .Values.frontend.enabled }}
---
# Frontend Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "microservices-app.fullname" . }}-frontend
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "microservices-app.frontend.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app: frontend
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow from Ingress Controller
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: ingress-nginx
    ports:
    - protocol: TCP
      port: {{ .Values.frontend.service.port }}
  egress:
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow to Backend
  {{- if .Values.backend.enabled }}
  - to:
    - podSelector:
        matchLabels:
          app: backend
    ports:
    - protocol: TCP
      port: {{ .Values.backend.service.port }}
  {{- end }}
{{- end }}

{{- if .Values.backend.enabled }}
---
# Backend Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "microservices-app.fullname" . }}-backend
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "microservices-app.backend.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow from Frontend
  {{- if .Values.frontend.enabled }}
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    ports:
    - protocol: TCP
      port: {{ .Values.backend.service.port }}
  {{- end }}
  # Allow from Ingress Controller (for direct /api access)
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: ingress-nginx
    ports:
    - protocol: TCP
      port: {{ .Values.backend.service.port }}
  egress:
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow to PostgreSQL
  {{- if .Values.postgresql.enabled }}
  - to:
    - podSelector:
        matchLabels:
          app: postgresql
    ports:
    - protocol: TCP
      port: 5432
  {{- end }}
  # Allow external HTTPS for APIs (if needed)
  {{- if .Values.networkPolicy.allowExternalEgress }}
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80
  {{- end }}
  # Allow to AI Agent
  {{- if .Values.aiAgent.enabled }}
  - to:
    - podSelector:
        matchLabels:
          app: ai-agent
    ports:
    - protocol: TCP
      port: {{ .Values.aiAgent.service.port }}
  {{- end }}
{{- end }}

{{- if .Values.postgresql.enabled }}
---
# PostgreSQL Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "microservices-app.fullname" . }}-postgresql
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "microservices-app.database.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app: postgresql
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow only from Backend
  {{- if .Values.backend.enabled }}
  - from:
    - podSelector:
        matchLabels:
          app: backend
    ports:
    - protocol: TCP
      port: 5432
  {{- end }}
  egress:
  # Allow DNS only
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow to AI Agent (for scoring)
  {{- if .Values.aiAgent.enabled }}
  - to:
    - podSelector:
        matchLabels:
          app: ai-agent
    ports:
    - protocol: TCP
      port: {{ .Values.aiAgent.service.port }}
  {{- end }}
{{- end }}

{{- if .Values.aiAgent.enabled }}
---
# AI Agent Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "microservices-app.fullname" . }}-ai-agent
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "microservices-app.labels" . | nindent 4 }}
    app.kubernetes.io/component: ai-agent
spec:
  podSelector:
    matchLabels:
      app: ai-agent
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow from Backend
  {{- if .Values.backend.enabled }}
  - from:
    - podSelector:
        matchLabels:
          app: backend
    ports:
    - protocol: TCP
      port: {{ .Values.aiAgent.service.port }}
  {{- end }}
  # Allow from PostgreSQL (for AI agent to query posts)
  {{- if .Values.postgresql.enabled }}
  - from:
    - podSelector:
        matchLabels:
          app: postgresql
    ports:
    - protocol: TCP
      port: {{ .Values.aiAgent.service.port }}
  {{- end }}
  egress:
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow to PostgreSQL
  {{- if .Values.postgresql.enabled }}
  - to:
    - podSelector:
        matchLabels:
          app: postgresql
    ports:
    - protocol: TCP
      port: 5432
  {{- end }}
  # Allow external HTTPS for OpenAI/Ollama
  {{- if .Values.networkPolicy.allowExternalEgress }}
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80
  {{- end }}
  # Allow to Ollama if using local model
  {{- if eq .Values.aiAgent.modelProvider "ollama" }}
  - to:
    - podSelector:
        matchLabels:
          app: ollama
    ports:
    - protocol: TCP
      port: 11434
  {{- end }}
{{- end }}
{{- end }}
