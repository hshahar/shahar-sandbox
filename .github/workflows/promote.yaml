name: Environment Promotion

on:
  workflow_dispatch:
    inputs:
      source_environment:
        description: 'Source environment'
        required: true
        type: choice
        options:
          - dev
          - staging
      target_environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - prod
      image_tag:
        description: 'Image tag to promote (e.g., develop-abc1234)'
        required: true
        type: string

jobs:
  validate-promotion:
    name: Validate Promotion
    runs-on: ubuntu-latest
    steps:
      - name: Validate promotion path
        run: |
          SOURCE="${{ github.event.inputs.source_environment }}"
          TARGET="${{ github.event.inputs.target_environment }}"
          
          if [[ "$SOURCE" == "dev" && "$TARGET" == "staging" ]]; then
            echo "‚úÖ Valid promotion: dev ‚Üí staging"
          elif [[ "$SOURCE" == "staging" && "$TARGET" == "prod" ]]; then
            echo "‚úÖ Valid promotion: staging ‚Üí production"
          else
            echo "‚ùå Invalid promotion path: $SOURCE ‚Üí $TARGET"
            echo "Valid paths: dev‚Üístaging, staging‚Üíprod"
            exit 1
          fi

      - name: Verify image exists
        run: |
          echo "Verifying image: ${{ github.event.inputs.image_tag }}"
          # In production, add actual image verification against registry

  request-approval:
    name: Request Approval
    runs-on: ubuntu-latest
    needs: validate-promotion
    environment:
      name: ${{ github.event.inputs.target_environment }}
    steps:
      - name: Approval checkpoint
        run: |
          echo "üîê Manual approval required for promotion to ${{ github.event.inputs.target_environment }}"
          echo "Source: ${{ github.event.inputs.source_environment }}"
          echo "Target: ${{ github.event.inputs.target_environment }}"
          echo "Image Tag: ${{ github.event.inputs.image_tag }}"

  run-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: request-approval
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run health checks
        run: |
          echo "Running health checks for image: ${{ github.event.inputs.image_tag }}"
          # Add actual health check tests here

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          # Add smoke tests here

      - name: Performance baseline check
        run: |
          echo "Checking performance baseline..."
          # Add performance tests here

  promote:
    name: Promote to ${{ github.event.inputs.target_environment }}
    runs-on: ubuntu-latest
    needs: run-tests
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update target environment values
        run: |
          TARGET="${{ github.event.inputs.target_environment }}"
          TAG="${{ github.event.inputs.image_tag }}"
          
          echo "Promoting image ${TAG} to ${TARGET}"
          
          sed -i "s|tag:.*|tag: ${TAG}|g" helm/microservices-app/values-${TARGET}.yaml

      - name: Commit promotion
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          TARGET="${{ github.event.inputs.target_environment }}"
          TAG="${{ github.event.inputs.image_tag }}"
          
          git add helm/microservices-app/values-${TARGET}.yaml
          git commit -m "promote: deploy ${TAG} to ${TARGET} [skip ci]"
          git push

      - name: Create promotion tag
        run: |
          TARGET="${{ github.event.inputs.target_environment }}"
          TAG="${{ github.event.inputs.image_tag }}"
          DATE=$(date +%Y%m%d-%H%M%S)
          
          git tag -a "promoted-${TARGET}-${DATE}" -m "Promoted ${TAG} to ${TARGET}"
          git push --tags

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: promote
    if: always()
    steps:
      - name: Promotion success notification
        if: needs.promote.result == 'success'
        run: |
          echo "‚úÖ Successfully promoted ${{ github.event.inputs.image_tag }} to ${{ github.event.inputs.target_environment }}"
          echo "ArgoCD will sync the changes automatically (if auto-sync is enabled)"
          # Add Slack/Teams notification here

      - name: Promotion failure notification
        if: needs.promote.result == 'failure'
        run: |
          echo "‚ùå Failed to promote to ${{ github.event.inputs.target_environment }}"
          # Add Slack/Teams notification here
